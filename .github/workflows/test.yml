name: CI/CD Pipeline

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: npm ci

    - name: Build the app
      run: npm run build

    - name: Run the app with Docker
      run: |
        docker build -t my-app .
        docker run -d -p 3000:3000 my-app
        sleep 5
    
    - name: Run ngrok in Docker
      run: |
        docker run --rm -d -p 4040:4040 -p 80:80 wernight/ngrok ngrok http 80
        sleep 5
        URL=$(curl -s localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "ngrok URL: $URL"
        echo "TEST_URL=$URL" >> $GITHUB_ENV

    - name: Post Test URL to PR
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const url = process.env.TEST_URL;
          const prNumber = context.payload.pull_request.number;

          if (!url) {
            throw new Error('Test URL is undefined');
          }

          const message = `Tests passed! You can view the test URL here: ${url}`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: message,
          });
    
    - name: Run tests
      run: npm run test --if-present
